name: DevSecOps CI Pipeline

# Trigger the pipeline when code is pushed to the 'main' branch
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build-secure-and-scan:
    runs-on: ubuntu-latest
    
    steps:
      # 1. Checkout Code
      # This pulls your code from GitHub into the runner
      - name: Checkout Source Code
        uses: actions/checkout@v3

      # 2. Set up Language Environment
      # Change this if your "basic program" is Node.js, Go, or Java
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'

      # 3. Install Dependencies
      # We need the dependencies installed to scan them
      - name: Install Dependencies
        run: |
          pip install -r requirements.txt

      # --- SECURITY STAGE 1: DEPENDENCY SCANNING (SCA) ---
      # Checks your libraries (requirements.txt) for known vulnerabilities
      - name: Snyk Dependency Scan
        uses: snyk/actions/python@master
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          command: monitor
          args: --severity-threshold=high

      # --- SECURITY STAGE 2: CODE QUALITY & BUGS (SAST) ---
      # Checks your actual source code for bugs and messy code
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}  # Built-in GitHub secret
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=43v3rn88b_my-devops-portfolio
            -Dsonar.organization=43v3rn88b

      # --- BUILD STAGE ---
      # Build the container image only if previous scans passed
      - name: Build Docker Image
        run: docker build -t my-app:${{ github.sha }} .

      # --- SECURITY STAGE 3: CONTAINER SCANNING ---
      # Checks the operating system inside your Docker image (e.g., Alpine/Ubuntu)
      - name: Run Trivy Image Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'my-app:${{ github.sha }}'
          format: 'table'
          exit-code: '0'          # Fail pipeline if vulnerability found
          ignore-unfixed: true    # Ignore bugs that don't have a fix yet
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

      - name: Start Container for Testing
        # We use the same image name Trivy scanned 
        run: |
          docker run -d -p 5000:5000 --name devops-app my-app:${{ github.sha }}
          # IMPORTANT: Give the app 5 seconds to boot up before k6 hits it
          sleep 5 

      - name: Run k6 Load Test
        uses: grafana/k6-action@v0.3.1
        with:
          filename: load-test.js
        # Add the --quiet flag to stop request-level logging
          flags: --quiet --log-output=none

      - name: Stop and Clean Up
        if: always() # Run this even if the load test fails
        run: docker stop devops-app && docker rm devops-app


      # --- FINAL STAGE: LOGIN & PUSH ---
      # Only runs if the image is secure. Pushes to Docker Hub.
      - name: Login to Docker Hub
        if: success() 
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Push Image to Docker Hub
        if: success()
        run: |
          docker tag my-app:${{ github.sha }} ${{ secrets.DOCKER_USERNAME }}/devops-portfolio:${{ github.sha }}
          docker push ${{ secrets.DOCKER_USERNAME }}/devops-portfolio:${{ github.sha }}
